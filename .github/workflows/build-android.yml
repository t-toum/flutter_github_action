name: Build Android APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      # üßæ Checkout
      - uses: actions/checkout@v4

      # üì¶ Read version from pubspec
      - name: Read version info
        id: version
        run: |
          VERSION_LINE=$(grep '^version:' pubspec.yaml | sed 's/version:[[:space:]]*//')
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'+' -f1)
          VERSION_CODE=$(echo "$VERSION_LINE" | cut -d'+' -f2)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT

      # üìù Read release notes
      - name: Read release notes
        id: notes
        run: |
          NOTES=$(cat release_notes.md | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "NOTES=$NOTES" >> $GITHUB_OUTPUT

      # üèóÔ∏è Slack ‚Äî BUILD STARTED
      - name: Slack Build Started
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                { "type": "header",
                  "text": { "type": "plain_text", "text": "üèóÔ∏è Android Build Started" }
                },
                { "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Repo:* ${{ github.repository }}" },
                    { "type": "mrkdwn", "text": "*Branch:* ${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*Actor:* ${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*Version:* v${{ steps.version.outputs.VERSION_NAME }}+${{ steps.version.outputs.VERSION_CODE }}" }
                  ]
                },
                { "type": "divider" },
                { "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Release Notes:*" }
                },
                { "type": "section",
                  "text": { "type": "mrkdwn", "text": "```${{ steps.notes.outputs.NOTES }}```" }
                }
              ]
            }

      # ‚òï Java + Flutter
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.24.3

      # üì¶ Dependencies
      - run: flutter pub get

      # üîê Create .env (FIXED v2 syntax)
      - name: Create .env
        uses: SpicyPizza/create-envfile@v2
        with:
          file_name: .env
          fail_on_empty: true
        env:
          APP_NAME: ${{ secrets.APP_NAME }}

      # ‚öôÔ∏è Envied generation
      - run: dart run build_runner build --delete-conflicting-outputs

      # üì± Build APK
      - run: flutter build apk --release

      # üì¶ Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk

      # üî• Firebase Distribution
      - name: Upload to Firebase
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: build/app/outputs/flutter-apk/app-release.apk
          releaseNotesFile: release_notes.md

      # üöÄ Slack SUCCESS
      - name: Slack Build Success
        if: success()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                { "type": "header",
                  "text": { "type": "plain_text", "text": "üöÄ Android Build Distributed" }
                },
                { "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Version:* v${{ steps.version.outputs.VERSION_NAME }}+${{ steps.version.outputs.VERSION_CODE }}" },
                    { "type": "mrkdwn", "text": "*Branch:* ${{ github.ref_name }}" }
                  ]
                }
              ]
            }

      # ‚ùå Slack FAILURE
      - name: Slack Build Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                { "type": "header",
                  "text": { "type": "plain_text", "text": "‚ùå Android Build Failed" }
                },
                { "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Branch:* ${{ github.ref_name }}" },
                    { "type": "mrkdwn", "text": "*Version:* v${{ steps.version.outputs.VERSION_NAME }}+${{ steps.version.outputs.VERSION_CODE }}" }
                  ]
                }
              ]
            }
